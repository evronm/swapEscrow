<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwapEscrow - Trustless Atomic Swaps</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        h1 {
            color: #667eea;
            font-size: 1.8em;
        }

        .subtitle {
            color: #666;
            font-size: 0.9em;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .escrow-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .escrow-item h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .escrow-item p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 5px;
        }

        .status.active {
            background: #d4edda;
            color: #155724;
        }

        .status.completed {
            background: #cce5ff;
            color: #004085;
        }

        .status.expired {
            background: #f8d7da;
            color: #721c24;
        }

        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .address {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 3px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            font-size: 0.9em;
            padding: 8px 15px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>SwapEscrow</h1>
                <p class="subtitle">Trustless atomic swaps with time-locked escrow</p>
            </div>
            <button id="connectBtn">Connect Wallet</button>
        </header>

        <div id="notConnected" class="card">
            <h2>Welcome to SwapEscrow</h2>
            <p>Connect your wallet to create and manage escrow contracts for trustless token swaps.</p>
            <p style="margin-top: 10px;"><strong>Features:</strong></p>
            <ul style="margin-left: 20px; margin-top: 10px;">
                <li>Support for Native ETH, ERC20, ERC721, and ERC1155 tokens</li>
                <li>Time-locked atomic swaps</li>
                <li>Multiple asset deposits</li>
                <li>Automatic expiry refunds</li>
            </ul>
        </div>

        <div id="connected" class="hidden">
            <div class="card">
                <div id="alerts"></div>

                <div class="form-group">
                    <label>Factory Address:</label>
                    <input type="text" id="factoryAddress" placeholder="0x...">
                    <p class="help-text">Enter the EscrowFactory contract address (required for all operations)</p>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="create">Create Escrow</div>
                <div class="tab" data-tab="my-escrows">My Escrows</div>
            </div>

            <!-- Create Escrow Tab -->
            <div id="createTab" class="card">
                <h2>Create New Escrow</h2>

                <div class="form-group">
                    <label>Duration (seconds):</label>
                    <input type="number" id="duration" placeholder="86400" value="86400">
                    <p class="help-text">86400 = 1 day, 604800 = 1 week</p>
                </div>

                <div class="form-group">
                    <label>Payment Asset Type:</label>
                    <select id="paymentType">
                        <option value="0">Native ETH</option>
                        <option value="1">ERC20</option>
                        <option value="2">ERC721</option>
                        <option value="3">ERC1155</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Payment Token Address:</label>
                    <input type="text" id="paymentToken" placeholder="0x...">
                    <p class="help-text">Use 0x0000000000000000000000000000000000000000 for Native ETH</p>
                </div>

                <div class="form-group">
                    <label>Payment Token ID:</label>
                    <input type="number" id="paymentTokenId" placeholder="0" value="0">
                    <p class="help-text">Used for ERC721 and ERC1155 only</p>
                </div>

                <div class="form-group">
                    <label>Payment Amount:</label>
                    <input type="text" id="paymentAmount" placeholder="1000000000000000000">
                    <p class="help-text">In wei for Native ETH and ERC20, or quantity for ERC1155. Ignored for ERC721.</p>
                </div>

                <button id="createEscrowBtn">Create Escrow</button>
            </div>

            <!-- My Escrows Tab -->
            <div id="myEscrowsTab" class="card hidden">
                <h2>My Escrows</h2>
                <button id="loadEscrowsBtn" style="margin-bottom: 15px;">Load My Escrows</button>
                <div id="escrowList" class="grid"></div>
            </div>
        </div>
    </div>

    <script>
        let provider, signer, account, factoryContract;

        const FACTORY_ABI = [
            "function createEscrow(uint256 duration, uint8 paymentAssetType, address paymentToken, uint256 paymentTokenId, uint256 paymentAmount) returns (address)",
            "function escrowCount() view returns (uint256)",
            "function getEscrow(uint256 escrowId) view returns (address)",
            "function escrows(uint256) view returns (address)",
            "event EscrowCreated(address indexed escrow, uint256 indexed escrowId, address indexed creator, uint256 duration, uint8 paymentAssetType, address paymentToken, uint256 paymentTokenId, uint256 paymentAmount)"
        ];

        const ESCROW_ABI = [
            "function duration() view returns (uint256)",
            "function paymentAssetType() view returns (uint8)",
            "function paymentToken() view returns (address)",
            "function paymentTokenId() view returns (uint256)",
            "function paymentAmount() view returns (uint256)",
            "function initialized() view returns (bool)",
            "function completed() view returns (bool)",
            "function expiryTime() view returns (uint256)",
            "function firstDepositor() view returns (address)",
            "function getDepositedAssetsCount() view returns (uint256)",
            "function getDepositedAsset(uint256 index) view returns (tuple(uint8 assetType, address tokenAddress, uint256 tokenId, uint256 amount, address depositor))",
            "function process(address token, address depositor)",
            "function withdrawExpired()"
        ];

        // Deployed contract addresses by chain ID
        const DEPLOYMENTS = {
            31337: "0x5FbDB2315678afecb367f032d93F642f64180aa3", // Anvil localhost
            // Add more chains as you deploy:
            // 1: "0x...", // Ethereum Mainnet
            // 11155111: "0x...", // Sepolia
            // 137: "0x...", // Polygon
            // 8453: "0x..." // Base
        };

        const CHAIN_NAMES = {
            1: "Ethereum Mainnet",
            11155111: "Sepolia",
            137: "Polygon",
            8453: "Base",
            31337: "Anvil (localhost)"
        };

        // Auto-load factory address based on chain
        async function loadFactoryAddress() {
            try {
                const network = await provider.getNetwork();
                const chainId = network.chainId;
                const factoryAddr = DEPLOYMENTS[chainId];

                if (factoryAddr) {
                    document.getElementById('factoryAddress').value = factoryAddr;
                    factoryContract = new ethers.Contract(factoryAddr, FACTORY_ABI, signer);

                    const chainName = CHAIN_NAMES[chainId] || `Chain ${chainId}`;
                    showAlert(`Connected to ${chainName}. Factory loaded at ${factoryAddr}`, 'success');
                } else {
                    const chainName = CHAIN_NAMES[chainId] || `Chain ${chainId}`;
                    showAlert(`Connected to ${chainName}. No factory deployed on this chain yet. Please enter address manually.`, 'info');
                }
            } catch (error) {
                console.error('Error loading factory address:', error);
            }
        }

        // Connect Wallet
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showAlert('Please install MetaMask!', 'error');
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                account = await signer.getAddress();

                document.getElementById('connectBtn').textContent = `${account.substring(0, 6)}...${account.substring(38)}`;
                document.getElementById('notConnected').classList.add('hidden');
                document.getElementById('connected').classList.remove('hidden');

                // Auto-load factory address for this chain
                await loadFactoryAddress();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        });

        // Factory Address Input
        document.getElementById('factoryAddress').addEventListener('change', (e) => {
            const address = e.target.value;
            if (ethers.utils.isAddress(address)) {
                factoryContract = new ethers.Contract(address, FACTORY_ABI, signer);
                showAlert('Factory address set!', 'success');
            } else if (address) {
                showAlert('Invalid factory address', 'error');
            }
        });

        // Create Escrow
        document.getElementById('createEscrowBtn').addEventListener('click', async () => {
            if (!factoryContract) {
                showAlert('Please enter a valid factory address first', 'error');
                return;
            }

            try {
                const duration = document.getElementById('duration').value;
                const paymentType = document.getElementById('paymentType').value;
                const paymentToken = document.getElementById('paymentToken').value;
                const paymentTokenId = document.getElementById('paymentTokenId').value;
                const paymentAmount = document.getElementById('paymentAmount').value;

                if (!ethers.utils.isAddress(paymentToken)) {
                    showAlert('Invalid payment token address', 'error');
                    return;
                }

                showAlert('Creating escrow... Please confirm transaction', 'info');

                const tx = await factoryContract.createEscrow(
                    duration,
                    paymentType,
                    paymentToken,
                    paymentTokenId,
                    paymentAmount
                );

                showAlert('Transaction submitted. Waiting for confirmation...', 'info');
                const receipt = await tx.wait();

                // Extract escrow address from event
                const event = receipt.events?.find(e => e.event === 'EscrowCreated');
                const escrowAddress = event?.args?.escrow;

                showAlert(`Escrow created at: ${escrowAddress}`, 'success');
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        });

        // Load My Escrows
        document.getElementById('loadEscrowsBtn').addEventListener('click', async () => {
            if (!factoryContract) {
                showAlert('Please enter a valid factory address first', 'error');
                return;
            }

            try {
                showAlert('Loading escrows...', 'info');
                const count = await factoryContract.escrowCount();
                const escrowList = document.getElementById('escrowList');
                escrowList.innerHTML = '';

                if (count.eq(0)) {
                    escrowList.innerHTML = '<p>No escrows found.</p>';
                    return;
                }

                for (let i = 0; i < count.toNumber(); i++) {
                    const escrowAddr = await factoryContract.getEscrow(i);
                    const escrow = new ethers.Contract(escrowAddr, ESCROW_ABI, provider);

                    const [completed, expiryTime, firstDepositor, assetCount] = await Promise.all([
                        escrow.completed(),
                        escrow.expiryTime(),
                        escrow.firstDepositor(),
                        escrow.getDepositedAssetsCount()
                    ]);

                    const now = Math.floor(Date.now() / 1000);
                    const expired = expiryTime.gt(0) && now > expiryTime.toNumber();

                    let status = 'active';
                    let statusText = 'Active';
                    if (completed) {
                        status = 'completed';
                        statusText = 'Completed';
                    } else if (expired) {
                        status = 'expired';
                        statusText = 'Expired';
                    }

                    const item = document.createElement('div');
                    item.className = 'escrow-item';
                    item.innerHTML = `
                        <h3>Escrow #${i}</h3>
                        <p><strong>Address:</strong> <span class="address">${escrowAddr}</span></p>
                        <p><strong>First Depositor:</strong> ${firstDepositor === ethers.constants.AddressZero ? 'None' : firstDepositor.substring(0, 10) + '...'}</p>
                        <p><strong>Assets Deposited:</strong> ${assetCount.toString()}</p>
                        ${expiryTime.gt(0) ? `<p><strong>Expires:</strong> ${new Date(expiryTime.toNumber() * 1000).toLocaleString()}</p>` : ''}
                        <span class="status ${status}">${statusText}</span>
                    `;
                    escrowList.appendChild(item);
                }

                clearAlert();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
            }
        });

        // Update field visibility based on payment type
        function updatePaymentFieldsVisibility() {
            const paymentType = document.getElementById('paymentType').value;
            const tokenAddressGroup = document.getElementById('paymentToken').parentElement;
            const tokenIdGroup = document.getElementById('paymentTokenId').parentElement;
            const amountGroup = document.getElementById('paymentAmount').parentElement;

            // Reset all to visible first
            tokenAddressGroup.style.display = 'block';
            tokenIdGroup.style.display = 'block';
            amountGroup.style.display = 'block';

            // 0 = NATIVE, 1 = ERC20, 2 = ERC721, 3 = ERC1155
            if (paymentType === '0') {
                // Native ETH: only amount
                tokenAddressGroup.style.display = 'none';
                tokenIdGroup.style.display = 'none';
                document.getElementById('paymentToken').value = '0x0000000000000000000000000000000000000000';
                document.getElementById('paymentTokenId').value = '0';
            } else if (paymentType === '1') {
                // ERC20: token address and amount
                tokenIdGroup.style.display = 'none';
                document.getElementById('paymentTokenId').value = '0';
            } else if (paymentType === '2') {
                // ERC721: token address and token ID
                amountGroup.style.display = 'none';
                document.getElementById('paymentAmount').value = '0';
            } else if (paymentType === '3') {
                // ERC1155: all fields
                // All visible
            }
        }

        // Listen for payment type changes
        document.getElementById('paymentType').addEventListener('change', updatePaymentFieldsVisibility);

        // Initialize on page load
        updatePaymentFieldsVisibility();

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.getElementById('createTab').classList.add('hidden');
                document.getElementById('myEscrowsTab').classList.add('hidden');

                if (tabName === 'create') {
                    document.getElementById('createTab').classList.remove('hidden');
                } else if (tabName === 'my-escrows') {
                    document.getElementById('myEscrowsTab').classList.remove('hidden');
                }
            });
        });

        // Alert helpers
        function showAlert(message, type) {
            const alerts = document.getElementById('alerts');
            alerts.innerHTML = `<div class="alert ${type}">${message}</div>`;
        }

        function clearAlert() {
            document.getElementById('alerts').innerHTML = '';
        }
    </script>
</body>
</html>
